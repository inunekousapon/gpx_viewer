{% extends "base.html" %}

{% block title %}{{ title }} - {{ app_name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 45vh;
        min-height: 300px;
        max-height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .map-info {
        margin-bottom: 0.75rem;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .map-info h3 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
    }
    .map-info p {
        margin: 0.15rem 0;
        font-size: 0.85rem;
        color: #666;
    }
    .back-link {
        display: inline-block;
        margin-bottom: 1rem;
        color: #007bff;
        text-decoration: none;
    }
    .back-link:hover {
        text-decoration: underline;
    }
    .time-slider-container {
        margin-bottom: 1rem;
        padding: 1.25rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .time-slider-container h4 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: #333;
    }
    .time-slider-wrapper {
        margin-bottom: 1rem;
    }
    .time-slider {
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: #e0e0e0;
        border-radius: 4px;
        outline: none;
        cursor: pointer;
    }
    .time-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: transform 0.1s ease;
    }
    .time-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }
    .time-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .time-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.5rem;
    }
    .current-time-display {
        text-align: center;
        padding: 0.75rem;
        background: #f0f7ff;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .current-time-display .time {
        font-size: 1.25rem;
        font-weight: 600;
        color: #007bff;
    }
    .current-time-display .date {
        font-size: 0.875rem;
        color: #666;
        margin-top: 0.25rem;
    }
    .slider-controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    .slider-controls button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background 0.2s ease;
    }
    .slider-controls .play-btn {
        background: #28a745;
        color: #fff;
    }
    .slider-controls .play-btn:hover {
        background: #218838;
    }
    .slider-controls .play-btn.playing {
        background: #dc3545;
    }
    .slider-controls .play-btn.playing:hover {
        background: #c82333;
    }
    .slider-controls .reset-btn {
        background: #6c757d;
        color: #fff;
    }
    .slider-controls .reset-btn:hover {
        background: #545b62;
    }
    .slider-controls .speed-btn {
        background: #17a2b8;
        color: #fff;
        min-width: 60px;
    }
    .slider-controls .speed-btn:hover {
        background: #138496;
    }
    .position-info {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #d4edda;
        border-radius: 4px;
        font-size: 0.875rem;
        color: #155724;
        display: none;
    }
    .position-info.show {
        display: block;
    }
    .position-info .coords {
        margin-bottom: 0.5rem;
    }
    .position-info .address {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(21, 87, 36, 0.2);
    }
    .position-info .address-loading {
        color: #666;
        font-style: italic;
    }
    .position-info .address-item {
        margin: 0.25rem 0;
    }
    .position-info .address-label {
        font-weight: 500;
        color: #155724;
    }
    .no-time-warning {
        padding: 0.75rem;
        background: #fff3cd;
        border-radius: 4px;
        color: #856404;
        font-size: 0.875rem;
    }
    .api-notice {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background: #e7f3ff;
        border-radius: 4px;
        font-size: 0.75rem;
        color: #0056b3;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .api-notice a {
        color: #0056b3;
        text-decoration: underline;
    }
    .api-notice a:hover {
        color: #003d82;
    }
    /* æ¨™é«˜ã‚°ãƒ©ãƒ• - æŠ˜ã‚ŠãŸãŸã¿å¼ */
    .elevation-chart-container {
        margin-top: 1rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .elevation-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
    }
    .elevation-header:hover {
        background: #e9ecef;
    }
    .elevation-header h4 {
        margin: 0;
        font-size: 0.9rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .elevation-header .summary {
        font-size: 0.75rem;
        color: #666;
        font-weight: normal;
    }
    .elevation-toggle {
        font-size: 0.75rem;
        color: #007bff;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .elevation-toggle .arrow {
        transition: transform 0.2s ease;
    }
    .elevation-chart-container.open .elevation-toggle .arrow {
        transform: rotate(180deg);
    }
    .elevation-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    .elevation-chart-container.open .elevation-content {
        max-height: 400px;
    }
    .elevation-chart-wrapper {
        position: relative;
        height: 180px;
        padding: 0.5rem 1rem;
    }
    .elevation-stats {
        display: flex;
        gap: 1rem;
        padding: 0.5rem 1rem 0.75rem;
        font-size: 0.7rem;
        color: #666;
        flex-wrap: wrap;
        border-top: 1px solid #eee;
    }
    .elevation-stats .stat-item {
        display: flex;
        align-items: center;
        gap: 0.2rem;
    }
    .elevation-stats .stat-value {
        font-weight: 600;
        color: #333;
    }
    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
    .main-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    /* ã‚¿ã‚¤ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
    .time-slider-container {
        margin-bottom: 0;
        padding: 0.75rem 1rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .time-slider-container h4 {
        display: none;
    }
    .current-time-display {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.25rem;
        background: #f0f7ff;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .current-time-display .date {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0;
    }
    .current-time-display .time {
        font-size: 1.1rem;
        font-weight: 600;
        color: #007bff;
    }
    .time-slider-wrapper {
        margin-bottom: 0.5rem;
    }
    .slider-controls {
        margin-bottom: 0.5rem;
    }
    .slider-controls button {
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
    }
    .position-info {
        margin-top: 0.5rem;
        padding: 0.5rem;
        font-size: 0.8rem;
    }
    .position-info .coords {
        margin-bottom: 0.25rem;
    }
    .position-info .address {
        margin-top: 0.25rem;
        padding-top: 0.25rem;
    }
    .api-notice {
        margin-top: 0.5rem;
        padding: 0.35rem 0.5rem;
        font-size: 0.65rem;
    }
</style>
{% endblock %}

{% block content %}
<a href="/" class="back-link">â† åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>

<div class="map-info">
    <h3>{{ gpx_data.filename }}</h3>
    <p>ãƒˆãƒ©ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæ•°: {{ gpx_data.point_count }}ç‚¹</p>
    {% if gpx_data.time_range %}
    <p style="font-size: 0.85rem; color: #666;">
        è¨˜éŒ²æœŸé–“: {{ gpx_data.time_range.start_local }} ï½ {{ gpx_data.time_range.end_local }}
    </p>
    {% endif %}
</div>

{% if gpx_data.time_range %}
<div class="main-content">
    <!-- åœ°å›³ï¼ˆä¸Šéƒ¨ï¼‰ -->
    <div id="map"></div>
    
    <!-- ã‚¿ã‚¤ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
    <div class="time-slider-container">
        <h4>ğŸ• ã‚¿ã‚¤ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼</h4>
        
        <div class="current-time-display">
            <div class="date" id="currentDate">-</div>
            <div class="time" id="currentTime">--:--:--</div>
        </div>
        
        <div class="time-slider-wrapper">
            <input type="range" class="time-slider" id="timeSlider" min="0" max="100" value="0" step="0.01">
            <div class="time-labels">
                <span id="startTimeLabel">{{ gpx_data.time_range.start_local }}</span>
                <span id="endTimeLabel">{{ gpx_data.time_range.end_local }}</span>
            </div>
        </div>
        
        <div class="slider-controls">
            <button type="button" class="play-btn" id="playBtn">â–¶ å†ç”Ÿ</button>
            <button type="button" class="speed-btn" id="speedBtn">1x</button>
            <button type="button" class="reset-btn" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <div class="position-info" id="positionInfo">
            <div class="coords" id="positionText"></div>
            <div class="address" id="addressInfo">
                <span class="address-loading">ä½æ‰€ã‚’å–å¾—ä¸­...</span>
            </div>
        </div>
        
        <div class="api-notice">
            <span>â„¹ï¸</span>
            <span>ä½æ‰€æƒ…å ±ã¯ <a href="https://operations.osmfoundation.org/policies/nominatim/" target="_blank" rel="noopener">Nominatim</a> ã‚’åˆ©ç”¨ã€‚å–å¾—ã¯1ç§’ã«1å›ã¾ã§ã€‚</span>
        </div>
    </div>
    
    <!-- æ¨™é«˜ã‚°ãƒ©ãƒ•ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ -->
    <div class="elevation-chart-container" id="elevationContainer">
        <div class="elevation-header" id="elevationHeader">
            <h4>ğŸ“ˆ æ¨™é«˜ã‚°ãƒ©ãƒ• <span class="summary" id="elevationSummary"></span></h4>
            <span class="elevation-toggle">è©³ç´° <span class="arrow">â–¼</span></span>
        </div>
        <div class="elevation-content">
            <div class="elevation-chart-wrapper">
                <canvas id="elevationChart"></canvas>
            </div>
            <div class="elevation-stats" id="elevationStats"></div>
        </div>
    </div>
</div>
{% else %}
<div class="main-content">
    <div id="map"></div>
    
    <div class="time-slider-container">
        <div class="no-time-warning">
            âš ï¸ ã“ã®GPXãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯æ™‚åˆ»æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¿ã‚¤ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
        </div>
    </div>
    
    <!-- æ¨™é«˜ã‚°ãƒ©ãƒ•ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ -->
    <div class="elevation-chart-container" id="elevationContainer">
        <div class="elevation-header" id="elevationHeader">
            <h4>ğŸ“ˆ æ¨™é«˜ã‚°ãƒ©ãƒ• <span class="summary" id="elevationSummary"></span></h4>
            <span class="elevation-toggle">è©³ç´° <span class="arrow">â–¼</span></span>
        </div>
        <div class="elevation-content">
            <div class="elevation-chart-wrapper">
                <canvas id="elevationChart"></canvas>
            </div>
            <div class="elevation-stats" id="elevationStats"></div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gpxData = {{ gpx_data | tojson }};
    
    // åœ°å›³åˆæœŸåŒ–
    const map = L.map('map');
    
    // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    // ãƒˆãƒ©ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒªãƒ©ã‚¤ãƒ³ã¨ã—ã¦æç”»
    const points = gpxData.points;
    const latlngs = points.map(p => [p.lat, p.lng]);
    
    // ãƒãƒªãƒ©ã‚¤ãƒ³æç”»
    const polyline = L.polyline(latlngs, {
        color: '#3388ff',
        weight: 4,
        opacity: 0.8
    }).addTo(map);
    
    // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼
    let startMarker = null;
    if (points.length > 0) {
        const startPoint = points[0];
        startMarker = L.marker([startPoint.lat, startPoint.lng])
            .bindPopup('<strong>ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹</strong><br>' + 
                (startPoint.time ? 'æ™‚åˆ»: ' + new Date(startPoint.time).toLocaleString('ja-JP') + '<br>' : '') +
                (startPoint.ele !== null ? 'é«˜åº¦: ' + startPoint.ele.toFixed(1) + 'm' : ''))
            .addTo(map);
    }
    
    // ã‚´ãƒ¼ãƒ«åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼
    let endMarker = null;
    if (points.length > 1) {
        const endPoint = points[points.length - 1];
        endMarker = L.marker([endPoint.lat, endPoint.lng])
            .bindPopup('<strong>ã‚´ãƒ¼ãƒ«åœ°ç‚¹</strong><br>' + 
                (endPoint.time ? 'æ™‚åˆ»: ' + new Date(endPoint.time).toLocaleString('ja-JP') + '<br>' : '') +
                (endPoint.ele !== null ? 'é«˜åº¦: ' + endPoint.ele.toFixed(1) + 'm' : ''))
            .addTo(map);
    }
    
    // å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹ã«åˆã‚ã›ã¦ã‚ºãƒ¼ãƒ 
    function fitMapToBounds() {
        if (gpxData.bounds) {
            const bounds = [
                [gpxData.bounds.min_lat, gpxData.bounds.min_lng],
                [gpxData.bounds.max_lat, gpxData.bounds.max_lng]
            ];
            map.fitBounds(bounds, { padding: [50, 50] });
        } else if (gpxData.center) {
            map.setView([gpxData.center.lat, gpxData.center.lng], 13);
        }
    }
    fitMapToBounds();

    // ===== æ¨™é«˜ã‚°ãƒ©ãƒ•ã®æç”» =====
    let elevationChart = null;
    let currentPointIndex = 0;
    
    // æ¨™é«˜ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º
    const pointsWithElevation = points.filter(p => p.ele !== null);
    
    if (pointsWithElevation.length > 0) {
        // è·é›¢ã‚’è¨ˆç®—ï¼ˆç´¯ç©è·é›¢ï¼‰
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // ç´¯ç©è·é›¢ã¨ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
        const distances = [0];
        const elevationData = [{x: 0, y: points[0].ele || 0, index: 0}];
        let totalDistance = 0;
        
        for (let i = 1; i < points.length; i++) {
            const prev = points[i-1];
            const curr = points[i];
            totalDistance += calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
            distances.push(totalDistance);
            if (curr.ele !== null) {
                elevationData.push({x: totalDistance / 1000, y: curr.ele, index: i});
            }
        }
        
        // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
        const elevations = pointsWithElevation.map(p => p.ele);
        const minEle = Math.min(...elevations);
        const maxEle = Math.max(...elevations);
        const avgEle = elevations.reduce((a, b) => a + b, 0) / elevations.length;
        
        // ç´¯ç©ä¸Šæ˜‡ãƒ»ä¸‹é™ã‚’è¨ˆç®—
        let totalAscent = 0;
        let totalDescent = 0;
        for (let i = 1; i < pointsWithElevation.length; i++) {
            const diff = pointsWithElevation[i].ele - pointsWithElevation[i-1].ele;
            if (diff > 0) totalAscent += diff;
            else totalDescent += Math.abs(diff);
        }
        
        // çµ±è¨ˆè¡¨ç¤º
        const statsEl = document.getElementById('elevationStats');
        statsEl.innerHTML = `
            <div class="stat-item">ğŸ“ ç·è·é›¢: <span class="stat-value">${(totalDistance / 1000).toFixed(2)} km</span></div>
            <div class="stat-item">â¬†ï¸ æœ€é«˜: <span class="stat-value">${maxEle.toFixed(0)} m</span></div>
            <div class="stat-item">â¬‡ï¸ æœ€ä½: <span class="stat-value">${minEle.toFixed(0)} m</span></div>
            <div class="stat-item">ğŸ“Š å¹³å‡: <span class="stat-value">${avgEle.toFixed(0)} m</span></div>
            <div class="stat-item">ğŸ”º ç´¯ç©ä¸Šæ˜‡: <span class="stat-value">${totalAscent.toFixed(0)} m</span></div>
            <div class="stat-item">ğŸ”» ç´¯ç©ä¸‹é™: <span class="stat-value">${totalDescent.toFixed(0)} m</span></div>
        `;
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤ºï¼ˆæŠ˜ã‚ŠãŸãŸã¿æ™‚ã«è¦‹ãˆã‚‹ï¼‰
        const summaryEl = document.getElementById('elevationSummary');
        summaryEl.textContent = `${(totalDistance / 1000).toFixed(1)}km | â†‘${totalAscent.toFixed(0)}m â†“${totalDescent.toFixed(0)}m`;
        
        // æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
        const elevationContainer = document.getElementById('elevationContainer');
        const elevationHeader = document.getElementById('elevationHeader');
        elevationHeader.addEventListener('click', function() {
            elevationContainer.classList.toggle('open');
            // ã‚°ãƒ©ãƒ•ã®ãƒªã‚µã‚¤ã‚º
            if (elevationChart && elevationContainer.classList.contains('open')) {
                setTimeout(() => elevationChart.resize(), 300);
            }
        });
        
        // Chart.js ã§ã‚°ãƒ©ãƒ•æç”»
        const ctx = document.getElementById('elevationChart').getContext('2d');
        elevationChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'æ¨™é«˜ (m)',
                    data: elevationData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }, {
                    label: 'ç¾åœ¨ä½ç½®',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: '#dc3545',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    showLine: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return `è·é›¢: ${context[0].parsed.x.toFixed(2)} km`;
                            },
                            label: function(context) {
                                return `æ¨™é«˜: ${context.parsed.y.toFixed(1)} m`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'è·é›¢ (km)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1);
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'æ¨™é«˜ (m)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(0);
                            }
                        }
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0 && elements[0].datasetIndex === 0) {
                        const dataIndex = elements[0].index;
                        const pointIndex = elevationData[dataIndex].index;
                        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ç§»å‹•
                        if (gpxData.time_range && slider) {
                            const ratio = pointIndex / (points.length - 1);
                            slider.value = ratio * 100;
                            updateFromSlider();
                        }
                    }
                }
            }
        });
        
        // ã‚°ãƒ©ãƒ•ä¸Šã®ç¾åœ¨ä½ç½®ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        window.updateElevationChartPosition = function(pointIndex) {
            if (!elevationChart) return;
            
            // æœ€ã‚‚è¿‘ã„æ¨™é«˜ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
            let nearestData = elevationData[0];
            for (const data of elevationData) {
                if (data.index <= pointIndex) {
                    nearestData = data;
                } else {
                    break;
                }
            }
            
            // ç¾åœ¨ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
            elevationChart.data.datasets[1].data = [{x: nearestData.x, y: nearestData.y}];
            elevationChart.update('none');
        };
    }

    // æ™‚åˆ»æƒ…å ±ãŒãªã„å ´åˆã¯çµ‚äº†
    if (!gpxData.time_range) {
        return;
    }

    // ç¾åœ¨ä½ç½®ãƒãƒ¼ã‚«ãƒ¼
    let currentMarker = null;
    const currentIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // æ™‚åˆ»æƒ…å ±ã‚’æŒã¤ãƒã‚¤ãƒ³ãƒˆã®ã¿æŠ½å‡º
    const pointsWithTime = points.filter(p => p.time).map(p => ({
        ...p,
        timestamp: new Date(p.time).getTime()
    })).sort((a, b) => a.timestamp - b.timestamp);

    if (pointsWithTime.length === 0) {
        return;
    }

    const startTime = pointsWithTime[0].timestamp;
    const endTime = pointsWithTime[pointsWithTime.length - 1].timestamp;
    const timeRange = endTime - startTime;

    // UIè¦ç´ 
    const slider = document.getElementById('timeSlider');
    const currentDateEl = document.getElementById('currentDate');
    const currentTimeEl = document.getElementById('currentTime');
    const playBtn = document.getElementById('playBtn');
    const speedBtn = document.getElementById('speedBtn');
    const resetBtn = document.getElementById('resetBtn');
    const positionInfo = document.getElementById('positionInfo');
    const positionText = document.getElementById('positionText');
    const addressInfo = document.getElementById('addressInfo');

    // é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    const addressCache = new Map();
    let addressFetchTimeout = null;
    let lastFetchedCoords = null;
    let pendingRequest = null;

    // é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ä½æ‰€å–å¾—ï¼‰
    async function fetchAddress(lat, lng) {
        const cacheKey = `${lat.toFixed(5)},${lng.toFixed(5)}`;
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
        if (addressCache.has(cacheKey)) {
            return addressCache.get(cacheKey);
        }

        try {
            // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ãƒ—ãƒ­ã‚­ã‚·APIã‚’ä½¿ç”¨
            const response = await fetch(
                `/api/reverse-geocode?lat=${lat}&lng=${lng}`
            );
            
            if (!response.ok) {
                throw new Error('API request failed');
            }
            
            const result = await response.json();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            addressCache.set(cacheKey, result);
            return result;
        } catch (error) {
            console.error('ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return null;
        }
    }

    // ä½æ‰€è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
    function updateAddressDisplay(lat, lng) {
        const coordKey = `${lat.toFixed(5)},${lng.toFixed(5)}`;
        
        // åŒã˜åº§æ¨™ãªã‚‰æ›´æ–°ã—ãªã„
        if (lastFetchedCoords === coordKey) {
            return;
        }
        
        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
        if (addressFetchTimeout) {
            clearTimeout(addressFetchTimeout);
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚Œã°å³åº§ã«è¡¨ç¤ºï¼ˆAPIã‚’å‘¼ã°ãªã„ï¼‰
        if (addressCache.has(coordKey)) {
            lastFetchedCoords = coordKey;
            const addr = addressCache.get(coordKey);
            renderAddress(addr);
            return;
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        addressInfo.innerHTML = '<span class="address-loading">ä½æ‰€ã‚’å–å¾—ä¸­...</span>';
        
        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹: 300mså¾Œã«å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã•ã‚Œã‚‹ãŸã‚çŸ­ãã¦OKï¼‰
        addressFetchTimeout = setTimeout(async () => {
            lastFetchedCoords = coordKey;
            const addr = await fetchAddress(lat, lng);
            renderAddress(addr);
        }, 300);
    }

    // ä½æ‰€ã‚’HTMLã§è¡¨ç¤º
    function renderAddress(addr) {
        if (!addr) {
            addressInfo.innerHTML = '<span class="address-loading">ä½æ‰€ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</span>';
            return;
        }
        
        let html = '';
        if (addr.prefecture) {
            html += `<div class="address-item"><span class="address-label">ğŸ›ï¸ éƒ½é“åºœçœŒ:</span> ${addr.prefecture}</div>`;
        }
        if (addr.city) {
            html += `<div class="address-item"><span class="address-label">ğŸ˜ï¸ å¸‚ç”ºæ‘:</span> ${addr.city}</div>`;
        }
        if (addr.road) {
            html += `<div class="address-item"><span class="address-label">ğŸ›£ï¸ é“è·¯:</span> ${addr.road}</div>`;
        }
        
        if (html === '') {
            html = '<span class="address-loading">ä½æ‰€æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</span>';
        }
        
        addressInfo.innerHTML = html;
    }

    // å†ç”ŸçŠ¶æ…‹
    let isPlaying = false;
    let playInterval = null;
    let playSpeed = 1;
    const speeds = [1, 2, 5, 10, 50, 100];
    let speedIndex = 0;

    // æ™‚åˆ»ã‹ã‚‰ãƒã‚¤ãƒ³ãƒˆã‚’æ¤œç´¢ï¼ˆç·šå½¢è£œé–“ï¼‰
    function getPointAtTime(targetTime) {
        if (targetTime <= startTime) {
            return pointsWithTime[0];
        }
        if (targetTime >= endTime) {
            return pointsWithTime[pointsWithTime.length - 1];
        }

        // äºŒåˆ†æ¢ç´¢ã§è¿‘ã„ãƒã‚¤ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
        let left = 0;
        let right = pointsWithTime.length - 1;
        
        while (left < right - 1) {
            const mid = Math.floor((left + right) / 2);
            if (pointsWithTime[mid].timestamp <= targetTime) {
                left = mid;
            } else {
                right = mid;
            }
        }

        const p1 = pointsWithTime[left];
        const p2 = pointsWithTime[right];

        // ç·šå½¢è£œé–“
        const ratio = (targetTime - p1.timestamp) / (p2.timestamp - p1.timestamp);
        return {
            lat: p1.lat + (p2.lat - p1.lat) * ratio,
            lng: p1.lng + (p2.lng - p1.lng) * ratio,
            ele: p1.ele !== null && p2.ele !== null 
                ? p1.ele + (p2.ele - p1.ele) * ratio 
                : p1.ele,
            time: new Date(targetTime).toISOString(),
            timestamp: targetTime
        };
    }

    // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
    function updateMarker(point, targetTime) {
        const date = new Date(targetTime);
        
        // æ—¥æ™‚è¡¨ç¤ºã‚’æ›´æ–°
        currentDateEl.textContent = date.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'short'
        });
        currentTimeEl.textContent = date.toLocaleTimeString('ja-JP');

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
        if (currentMarker) {
            currentMarker.setLatLng([point.lat, point.lng]);
        } else {
            currentMarker = L.marker([point.lat, point.lng], { icon: currentIcon }).addTo(map);
        }

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹ã‚’æ›´æ–°
        currentMarker.bindPopup(
            '<strong>ğŸ“ ç¾åœ¨ä½ç½®</strong><br>' +
            'æ™‚åˆ»: ' + date.toLocaleString('ja-JP') + '<br>' +
            (point.ele !== null ? 'é«˜åº¦: ' + point.ele.toFixed(1) + 'm<br>' : '') +
            'ç·¯åº¦: ' + point.lat.toFixed(6) + '<br>' +
            'çµŒåº¦: ' + point.lng.toFixed(6)
        );

        // ä½ç½®æƒ…å ±è¡¨ç¤º
        positionInfo.classList.add('show');
        positionText.textContent = 'ğŸ“ ç·¯åº¦: ' + point.lat.toFixed(6) + ', çµŒåº¦: ' + point.lng.toFixed(6) +
            (point.ele !== null ? ', é«˜åº¦: ' + point.ele.toFixed(1) + 'm' : '');
        
        // ä½æ‰€æƒ…å ±ã‚’å–å¾—ãƒ»è¡¨ç¤º
        updateAddressDisplay(point.lat, point.lng);
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã‹ã‚‰æ™‚åˆ»ã‚’è¨ˆç®—ã—ã¦æ›´æ–°
    function updateFromSlider() {
        const sliderValue = parseFloat(slider.value);
        const targetTime = startTime + (timeRange * sliderValue / 100);
        const point = getPointAtTime(targetTime);
        updateMarker(point, targetTime);
        
        // æ¨™é«˜ã‚°ãƒ©ãƒ•ã®ç¾åœ¨ä½ç½®ã‚’æ›´æ–°
        const pointIndex = Math.floor(sliderValue / 100 * (points.length - 1));
        if (window.updateElevationChartPosition) {
            window.updateElevationChartPosition(pointIndex);
        }
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
    slider.addEventListener('input', function() {
        updateFromSlider();
    });

    // å†ç”Ÿãƒœã‚¿ãƒ³
    playBtn.addEventListener('click', function() {
        if (isPlaying) {
            // åœæ­¢
            isPlaying = false;
            clearInterval(playInterval);
            playBtn.textContent = 'â–¶ å†ç”Ÿ';
            playBtn.classList.remove('playing');
        } else {
            // å†ç”Ÿé–‹å§‹
            isPlaying = true;
            playBtn.textContent = 'â¸ åœæ­¢';
            playBtn.classList.add('playing');
            
            // æœ€å¾Œã¾ã§è¡Œã£ã¦ã„ãŸã‚‰æœ€åˆã‹ã‚‰
            if (parseFloat(slider.value) >= 100) {
                slider.value = 0;
            }

            playInterval = setInterval(function() {
                let newValue = parseFloat(slider.value) + 0.1 * playSpeed;
                if (newValue >= 100) {
                    newValue = 100;
                    isPlaying = false;
                    clearInterval(playInterval);
                    playBtn.textContent = 'â–¶ å†ç”Ÿ';
                    playBtn.classList.remove('playing');
                }
                slider.value = newValue;
                updateFromSlider();
            }, 50);
        }
    });

    // é€Ÿåº¦ãƒœã‚¿ãƒ³
    speedBtn.addEventListener('click', function() {
        speedIndex = (speedIndex + 1) % speeds.length;
        playSpeed = speeds[speedIndex];
        speedBtn.textContent = playSpeed + 'x';
    });

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    resetBtn.addEventListener('click', function() {
        // å†ç”Ÿåœæ­¢
        if (isPlaying) {
            isPlaying = false;
            clearInterval(playInterval);
            playBtn.textContent = 'â–¶ å†ç”Ÿ';
            playBtn.classList.remove('playing');
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        slider.value = 0;
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
        if (currentMarker) {
            map.removeLayer(currentMarker);
            currentMarker = null;
        }

        // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
        currentDateEl.textContent = '-';
        currentTimeEl.textContent = '--:--:--';
        positionInfo.classList.remove('show');
        addressInfo.innerHTML = '<span class="address-loading">ä½æ‰€ã‚’å–å¾—ä¸­...</span>';
        lastFetchedCoords = null;

        // æ¨™é«˜ã‚°ãƒ©ãƒ•ã®ç¾åœ¨ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        if (window.updateElevationChartPosition) {
            window.updateElevationChartPosition(0);
        }

        // å…¨ä½“è¡¨ç¤ºã«æˆ»ã™
        fitMapToBounds();
    });

    // åˆæœŸè¡¨ç¤º
    updateFromSlider();
});
</script>
{% endblock %}
